{"name":"Html5 uart bl","tagline":"HTML5 base UART bootloader updater software in embedded system design","body":"## Silicon Labs MCU serial Bootloader Data Source\r\nThis is a basic demo that demonstrates ability of HTML5 and JavaScript to make a desktop application.\r\n\r\nHere we pickup and example for 8 bit MCU bootloader download software. \r\nWhich we can get more information from silabs UART bootloader solution:\r\n\r\nhttp://www.silabs.com/Support%20Documents/TechnicalDocs/AN778.pdf<br>\r\nhttp://www.silabs.com/Support%20Documents/Software/AN778SW.zip\r\n\r\nWe use HTML5, JavaScript, Node-Webkit to setup the PC application which act as original C# software.\r\n\r\n## Introduction\r\n In embedded system design, we need to design desktop application to communicate with embedded devices. It is normally written by C++, C#, or TCL. And it is limited with OS environment. Developer needs to design different software version for Windows, Mac OS and Linux. For those cross platform requirement, we have better solution on it. Browser is common thing on various OS, just follow the HTML5 standard. Design a desktop application with HTML5, we can achieve the cross platform target, it can runs on Windows, Linux and Mac. The programing languages are HTML5, JavaScript and CSS. In the below section, we will investigate it in detail on how to design a HTML5 desktop application in embedded system design.\r\n\r\n## Sublime Text 2\r\n  Sublime is wonderful text editor which support multi-platform.  It is recommended to install it before we start looking into HTML5 things.\r\n\r\n###  Install the Sublime Text 2\r\n\r\nGo to http://www.sublimetext.com/2, download Sublime Text 2 according your OS environment.\r\n* OS X (OS X 10.6 or later is required)\r\n* Windows - also available as a portable version\r\n* Windows 64 bit - also available as a portable version\r\n* Linux 32 bit\r\n* Linux 64 bit\r\n\r\n###  Install package control\r\n\r\nThis helps us easier to install other plugin. Press CTRL+ ~ to console displayed, past below scripts in console and press ENTER.\r\n> import urllib2,os;pf='Package Control.sublime-package';ipp=sublime.installed_packages_path();os.makedirs(ipp) if not os.path.exists(ipp) else None;open(os.path.join(ipp,pf),'wb').write(urllib2.urlopen('http://sublime.wbond.net/'+pf.replace(' ','%20')).read())\r\n\r\n\r\nOnce installation completed, restart Sublime Text2, we will see Package Control in Preference -> Package Settings\r\n\r\n### Plugin install\r\n\r\n#### a) jsFormat\r\n\r\nSometimes we got JavaScript code which has been compressed. Like below.\r\n\r\n![image001.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image001.png)<br>\r\nIt is no convenient to understand the code, press CTRL+ALT+F, the code has been formatted with beautiful form.\r\n\r\n![image002.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image002.png)<br>\r\n\r\n#### b) DocBlockr\r\n\r\nType /** and press enter, it will automatically generate doxygen compatible function description.\r\n\r\n![image003.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image003.png)<br>\r\n\r\n#### c) SublimeLinter\r\n\r\nAutomatically check programming language grammar error. Below example shows missing semicolon case, it shows a red exclamation mark on left of the line.  And display the error information in status bar at bottom of the window.\r\n\r\n![image004.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image004.png)<br>\r\n![image005.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image005.png)<br>\r\n\r\n## HTML5\r\n\r\n![image007.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image007.png)<br>\r\n\r\n### Introduction\r\n\r\nHTML5 is a markup language used for structuring and presenting content for the World Wide Web and a core technology of the Internet. It is the fifth revision of the HTML standard.\r\n\r\nIn addition to specifying markup, HTML5 specifies scripting application programming Interfaces (APIs) that can be used with JavaScript. Existing document object model (DOM) interfaces are extended and de facto features documented. There are also new APIs, such as:\r\n\r\nHTML5 related APIs.\r\n* The canvas element for immediate mode 2D drawing. See Canvas 2D API Specification 1.0 specification\r\n* Timed media playback\r\n* Offline Web Applications\r\n* Document editing\r\n* Drag-and-drop\r\n* Cross-document messaging\r\n* Browser history management\r\n* MIME type and protocol handler registration\r\n* Microdata\r\n* Web Storage, a key-value pair storage framework that provides behaviour similar to cookies but with larger storage capacity and improved API.\r\n\r\n### Useful stuffs\r\n\r\n[http://diveintohtml5.info/canvas.html](http://diveintohtml5.info/canvas.html) <br>\r\n[http://www.w3schools.com/html/html5_intro.asp](http://www.w3schools.com/html/html5_intro.asp)\r\n\r\n## JavaScript\r\n\r\n![image009.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image009.png)<br>\r\n\r\n### Introduction\r\n\r\nJavaScript (JS) is an interpreted computer programming language. As part of web browsers, implementations allow client-side scripts to interact with the user, control the browser, communicate asynchronously, and alter the document content that is displayed. It has also become common in server-side programming, game development and the creation of desktop applications.\r\n\r\nJavaScript is a prototype-based scripting language with dynamic typing and has first-class functions. Its syntax was influenced by C. JavaScript copies many names and naming conventions from Java, but the two languages are otherwise unrelated and have very different semantics. The key design principles within JavaScript are taken from the Self and Scheme programming languages. It is a multi-paradigm language, supporting object-oriented, imperative, and functional programming styles.\r\n\r\nJavaScript was originally developed by Brendan Eich in Netscape.\r\n\r\nAlthough it was developed under the name Mocha, the language was officially called LiveScript when it first shipped in beta releases of Netscape Navigator 2.0 in September 1995, but it was renamed JavaScript when it was deployed in the Netscape browser version 2.0B3.\r\n\r\nThe change of name from LiveScript to JavaScript roughly coincided with Netscape adding support for Java technology in its Netscape Navigator web browser. The final choice of name caused confusion, giving the impression that the language was a spin-off of the Java programming language, and the choice has been characterized by many as a marketing ploy by Netscape to give JavaScript the cachet of what was then the hot new web programming language.\r\n\r\n## Node.js\r\n\r\n![image010.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image010.png)<br>\r\n\r\n### Introduction\r\n\r\nNode.js is a software platform that is used to build scalable network (especially server-side) applications. Node.js utilizes JavaScript as its scripting language, and achieves high throughput via non-blocking I/O and a single-threaded event loop.\r\n\r\nNode.js contains a built-in HTTP server library, making it possible to run a web server without the use of external software, such as Apache or Lighttpd, and allowing more control of how the web server works.\r\n\r\nNode.js was created by Ryan Dahl starting in 2009. Its development and maintenance is sponsored by Joyent.\r\n\r\nNode.js is a packaged compilation of Google's V8 JavaScript engine, the platform abstraction layer, and a core library, which is itself primarily written in JavaScript.\r\n\r\nDahl's original goal was to create web sites with push capabilities as seen in web applications like Gmail. After trying solutions in several other programming languages he chose JavaScript because of the lack of an existing I/O API. This allowed him to define a convention of non-blocking, event-driven I/O.\r\n\r\n### Useful stuffs\r\n\r\n* Download Node.js from http://nodejs.org/ <br>\r\nIt support Windows, Macintosh and Lnux. <br>\r\n![image011.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image011.png)<br>\r\nNode.js is released under the MIT license, and bundles other liberally licensed OSS components.\r\n* A good place to study node.js, http://www.nodebeginner.org/ <br>\r\n\r\n## Webkit\r\n\r\n![image012.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image012.png)<br>\r\n\r\n### Introduction\r\n\r\n Node-webkit is an app runtime based on Chromium and node.js. You can write native apps in HTML and JavaScript with node-webkit. It also lets you call Node.js modules directly from the DOM and enables a new way of writing native applications with all Web technologies.\r\n\r\n### Features\r\n\r\n* Apps written in modern HTML5, CSS3, JS and WebGL.\r\n* Complete support for Node.js APIs and all its third party modules.\r\n* Good performance: Node and WebKit runs in the same thread: Function calls are made straightforward; objects are in the same heap and can just reference each other;\r\n* Easy to package and distribute apps.\r\n* Available on Linux, Mac OSX and Windows.\r\n\r\n### Installation\r\n\r\n1. Download latest version from https://github.com/rogerwang/node-webkit\r\n2. Extract the package and copy all files into directory C:\\Program Files\\node-webkit\r\n3. Configure build and debugging setting in Sublime Text2  for Node-webkit Windows. \r\n\r\n* Select Tools->Build system->New Build System, it opens a new file named “untiled.sublime-build”.<br> \r\n* Copy below code into untiled.sublime-build and save it as “Node-webkit.sublime-build” <br>\r\n```json\r\n{\r\n    \"cmd\": [\"nw.exe\", \"--enable-logging\", \"${project_path:${file_path}}\"],\r\n    \"working_dir\": \"${project_path:${file_path}}\",\r\n    \"path\": \"C:/Program Files/node-webkit/\"\r\n}\r\n```\r\n* Press Ctrl+B to build your project.\r\n\r\n  Please find more information from official website. \r\n  https://github.com/rogerwang/node-webkit/wiki/Debugging-with-Sublime-Text-2\r\n \r\n### Desktop application example\r\n\r\n#### Hello World example\r\n\r\n1. Create index.html\r\n\r\n![image013.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image013.png)<br>\r\n2. Create package.json\r\n```json\r\n{\r\n    \"name\": \"nw-demo\",\r\n    \"main\": \"index.html\"\r\n}\r\n```\r\n3. Run project by pressing Ctrl+B,  it shows below window.\r\n\r\n![image014.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image014.png)<br>\r\n\r\n#### Official demo code\r\n\r\nThere are several example codes in https://github.com/zcbenz/nw-sample-apps <br>\r\nHere is snap of one example code “menus”\r\n\r\n![image015.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image015.png)<br>\r\n\r\n## Real Desktop application example\r\n\r\nNow we can start working on a real application examples. According the procedure, we can familiar with desktop application development with Node-webkit.\r\nWe have an F33x UART bootloader PC application, written by C#, the user interface shows below, let us make same one with HTML5 and JavaScript.\r\nGet reference from:\r\n\r\nhttp://www.silabs.com/Support%20Documents/TechnicalDocs/AN778.pdf\r\nhttp://www.silabs.com/Support%20Documents/Software/AN778SW.zip\r\n\r\n![image016.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image016.png)<br>\r\n\r\n### UI implementation\r\n\r\nThere are four buttons, two check boxes, six drop down lists, one table, and one text area.\r\n\r\na). **Add drop down lists**\r\n\r\nGet reference from http://www.w3schools.com/tags/tag_select.asp.\r\n\r\n![image017.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image017.png)<br>\r\nThe effort shows close to C# appearance.\r\n\r\n![image018.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image018.png)<br>\r\n\r\nb). **Add button**\r\n\r\nGet reference from http://www.w3schools.com/tags/tag_button.asp\r\n\r\n![image019.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image019.png)<br>\r\nThe effort looks good.\r\n\r\n![image020.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image020.png)<br>\r\n\r\nc). **Add Tables**\r\n\r\nGet reference from http://www.w3schools.com/html/html_tables.asp\r\n\r\n![image022.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image022.png)<br>\r\nThe effort looks good too.\r\n\r\n![image023.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image023.png)<br>\r\n\r\nd). **Checkbox**\r\n\r\nGet reference from http://www.w3schools.com/jsref/prop_checkbox_checked.asp\r\n\r\n![image024.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image024.png)<br>\r\nThe effort looks good.\r\n\r\n![image025.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image025.png)<br>\r\n\r\ne). **Text area**\r\n\r\nGet reference from http://www.w3schools.com/tags/tag_textarea.asp\r\n\r\n![image026.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image026.png)<br>\r\nThe effort looks good too.\r\n\r\n![image027.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image027.png)<br>\r\n\r\nf). **Final display effort**\r\n\r\nGet reference from http://www.w3schools.com/html/html_examples.asp <br>\r\nAfter fine tune UI layout, the final appearance looks like below snapshot.\r\n\r\n![image028.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image028.png)<br>\r\n\r\n### File system access\r\nWe need open hex file from explorer window and read file contents.\r\n\r\na). **Open file Dialog**\r\n\r\nHere we want click on button “Select Hex File(s)”, it should display file open dialog to select input file. Here we need start coding JavaScript to achieve file access function. \r\nGet reference from http://www.w3schools.com/jsref/dom_obj_fileupload.asp\r\n\r\n* In index.html\r\n\r\nAdd input tag to for file upload, the id is “openFile”, the id can be access by JavaScript code. And set it not display style. Also add script tag to execute script.js.\r\n\r\n![image030.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image030.png)<br>\r\nAnd then change button tag of “Select Hex File(s)”, id is “openHexFile”, onClick event handler function is openFileOption().\r\n\r\n![image031.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image031.png)<br>\r\n\r\n*  In script.js\r\n\r\nAdd openFileOption(), notice getElementById() with id ‘openFile’, which defined in indel.html input TAG. And with onClick event of input tag, it call handleFiles, which print out selected file name on console.\r\n```javascript\r\nfunction openFileOption() {\r\n  document.getElementById(\"openFile\").click();\r\n}\r\nfunction handleFiles(files) {\r\n  for (var i = 0; i < files.length; ++i)\r\n         console.log(files[i].name);\r\n}\r\n```\r\n* Press Ctrl+B, click on button “Select Hex File(s)”, we can see a file dialog appeared.\r\n\r\n![image032.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image032.png)<br>\r\n\r\nb).  **Read file contents**\r\n\r\nHere we need node.js to access local storage file. <br>\r\nGet reference from http://nodejs.org/api/fs.html#fs_fs_readfile_filename_options_callback <br>\r\nIn script.js\r\n```javascript\r\nvar fs = require('fs');\r\nfunction handleFiles(files) {\r\n  fs.readFile(files[0].name, 'utf8', function(err,data) {\r\n         if (err) throw err;\r\n         console.log(data);\r\n  });\r\n}\r\n```\r\nPress Ctrl+B, click on button ”Select Hex File(s)”, select Sample_User_Application.hex file, and then we can see Hex file contents output in console.\r\n>[3928:1120/153906:INFO:CONSOLE(6)]\"\":03040000020447AC\\r\\n:0C044700787FE4F6D8FD758107020433CD\\r\\n:1004330053D9BF1204037FB07E63120415D2AFE415\\r\\n:04044300F5A780FE9B\\r\\n:0D040300AFA775A70F75E24043AF048FA7A8\\r\\n:0104100022C9\\r\\n:10041500ADA775A70FE4F5C8C39FFFE49EF5CB8F85\\r\\n:0D042500CA74FFF5CDF5CCD2ADD2CA8DA7BB\\r\\n:0104320022A7\\r\\n:030412000204538E\\r\\n:05045300C2CFB2B2327D\\r\\n:0B77F500250101020136071BA5C23D63\\r\\n:00000001FF\\r\\n\"\",\r\n\r\n### Hex file analysis\r\n\r\na). **Introduction**\r\n\r\nIntel HEX is a file format for conveying binary information for applications like programming microcontrollers, EPROMs, and other kinds of chips. The format is a text file, with each line containing hexadecimal values encoding a sequence of data and their starting offset or absolute address.\r\nEach line of Intel HEX file consists of six parts:\r\n* **Start code**, one character, an ASCII colon ':'.\r\n* **Byte count**, two hex digits, a number of bytes (hex digit pairs) in the data field. 16 (0x10) or 32 (0x20) bytes of data are the usual compromise values between line length and address overhead.\r\n* **Address**, four hex digits, a 16-bit address of the beginning of the memory position for the data. Limited to 64 kilobytes, the limit is worked around by specifying higher bits via additional record types.\r\n* **Record type**, two hex digits, 00 to 05, defining the type of the data field.\r\n* **Data**, a sequence of n bytes of the data themselves, represented by 2n hex digits.\r\n* **Checksum**, two hex digits \r\n\r\nExample of Hex file\r\n\r\n![image034.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image034.png)<br>\r\n\r\nb). **Hex parser coding**\r\n\r\nGet reference from https://github.com/bminer/intel-hex.js\r\n*  **User firmware structure:**\r\n\r\nThe user firmware application structure look like below. The user firmware start address from 0x400, and at end of user firmware area, there is application info block which record the user firmware information, something like App start Address, App End Address, BL type, etc.\r\n\r\n![image036.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image036.png)<br>\r\nIn our example, the user application firmware start address is 0x400, however, the application info block address at 0x77F5. That means two pages are needed for this firmware, and a lot of pages bare between first occurred page and last occurred page.\r\n\r\n* **Modification on Intel-hex.js:**\r\n\r\nThe original hex parser JavaScript will fill 0xFF in page which is not used. In our case, it will generate a big image from address 0x0000 to 0x7800, which is too large for us.  So an array flashPageInUse added in intel-hex.js to record which page is being used. It also as one of return values.\r\n\r\n**Part of original hex file:**\r\n\r\n:03040000020447AC\r\nThe data segment is “020447”.\r\n\r\n**Part of parsed hex file output:**\r\n\r\n[3572:1121/101801:INFO:CONSOLE(18)] \"{\"0\":2,\"1\":4,\"2\":71,\r\nIt is 02, 04, 71(0x47), the result shows correct value.\r\n\r\n* **Parse application info block**\r\n\r\nHere is definition of info block, these information needed display to Table in UI.\r\n```c\r\nSEGMENT_VARIABLE(TGT_App_InfoBlock[], const U8, SEG_CODE) =\r\n{\r\n  BL_SPECIFIC_BYTE,\r\n  APP_FW_VERSION_HIGH,\r\n  APP_FW_VERSION_LOW,\r\n  TGT_FLASH_PAGE_SIZE_CODE,\r\n  TGT_BL_TYPE,\r\n  TGT_MCU_CODE,\r\n  TGT_APP_INFOBLOCK_LENGTH,\r\n  SIG_BYTE3,\r\n  SIG_BYTE2,\r\n  SIG_BYTE1,\r\n  SIG_BYTE0,\r\n};\r\n```\r\n\r\n* **Output to Table**\r\n\r\nNamed table id = ‘infoBlock’ in index.html\r\nOpen the table by id in script.js, and handle info block from hex parse result.\r\n\r\n```c\r\nfunction infoBlockDisplay(tmp) {\r\n  var infoTable = document.getElementById('infoBlock');\r\n  // MCU code\r\n  infoTable.rows[1].cells[1].innerHTML = '0x' + tmp[FLASH_PAGE_SIZE - 6].toString(16);\r\n  // BL type\r\n  if (tmp[FLASH_PAGE_SIZE - 7] == 1) {\r\n         infoTable.rows[2].cells[1].innerHTML = 'UART';\r\n  }\r\n  // Flash page size\r\n  if (tmp[FLASH_PAGE_SIZE - 8] == 2) {\r\n         infoTable.rows[3].cells[1].innerHTML = '1024';\r\n  } else if(tmp[FLASH_PAGE_SIZE - 8] == 1) {\r\n         infoTable.rows[3].cells[1].innerHTML = '512';\r\n  }\r\n  // App FW Version\r\n  var ver_high = tmp[FLASH_PAGE_SIZE - 10].toString();\r\n  var ver_low  = tmp[FLASH_PAGE_SIZE - 9].toString();\r\n  infoTable.rows[4].cells[1].innerHTML = ver_high + '.' + ver_low;\r\n  // Reserved\r\n  infoTable.rows[5].cells[1].innerHTML = '0x' + tmp[FLASH_PAGE_SIZE - 11].toString(16);\r\n  // App Start Addr\r\n  infoTable.rows[6].cells[1].innerHTML = firmwareStartAddress;\r\n  // App End Addr\r\n  infoTable.rows[7].cells[1].innerHTML = firmwareEndAddress;\r\n}\r\n```\r\n\r\n* **Run result**\r\n\r\nPress Ctrl + b, click on button “Select Hex file(s)”, and choose Sample_User_Application.hex in file dialog. The result looks good.\r\n\r\n![image038.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image038.png)<br>\r\n\r\n### Serial port communication\r\n\r\nReference from https://github.com/voodootikigod/node-serialport\r\n\r\n1. **Install serialport plug in for Node.js** <br>\r\nBefore install serialport plug in for Node.js, we need to install Python 2.76. http://www.python.org/download/releases/2.7.6/,\r\n$npm install serialport\r\n\r\n2. **Install nw-gyp** <br>\r\nThings become a little difference between normal node.js third party plugin, node-webkit need to rebuild the plug in. Get reference from  https://github.com/rogerwang/node-webkit/wiki/Using-Node-modules 3rd party modules with C/C++ addons.\r\n$ npm install nw-gyp –g\r\n\r\n3. **Rebuild node-webkit** <br>\r\nEnter serialport module directory.\r\n$ nw-gyp rebuild --target=0.8.0\r\n\r\n4. **To use** <br>\r\n\r\n* **Output string “OMG IT WORS” to COM4**\r\n```javascript\r\nvar serialport = require('serialport');\r\nvar com = serialport.SerialPort;\r\nvar serialPort = new com('COM4', {\r\n  baudrate: 115200\r\n});\r\nfunction serialPortTesting() {\r\n  console.log('COM port open test\\n');\r\n  serialPort.write(\"OMG IT WORKS\\r\");\r\n}\r\n```\r\nAlso add serialPortTesting() function in anywhere you want. Check the COM4 output with serial terminal tool, we can see sting “OMG IT WORKS” appear on the terminal tool. That means the serial port operation works.\r\n\r\n* **List all COM ports**\r\n```javascript\r\n serialport.list(function (err, ports) {\r\n         ports.forEach(function(port) {\r\n                 console.log(port.comName);\r\n                 console.log(port.pnpId);\r\n                 console.log(port.manufacturer);\r\n         });\r\n  });\r\n```\r\nWe can see the output from console.\r\n```\r\n \"\"COM3\"\",\r\n \"\"USB\\\\VID_10C4&PID_EA60\\\\0001\"\",\r\n \"\"Silicon Laboratories\"\" ,\r\n \"\"COM1\"\",\r\n \"\"ACPI\\\\PNP0501\\\\0\"\",\r\n \"\"(Standard port types)\"\",\r\n \"\"COM4\"\",\r\n \"\"USB\\\\VID_10C4&PID_EA60\\\\0003\"\"\r\n \"\"Silicon Laboratories\"\",\r\n```\r\n\r\n* **Update COM port dropdown list**\r\n```javascript\r\nfunction serialPortList() {\r\n  serialport.list(function (err, ports) {\r\n         var coms = [];\r\n         var cnt = 0;\r\n         ports.forEach(function(port) {\r\n                 coms[cnt++] = port.comName;\r\n         });\r\n         coms.sort();\r\n         var comPortInput = document.getElementById('comPort');\r\n         coms.forEach(function(com) {\r\n                 var option = document.createElement('option');\r\n                 option.text = com;\r\n                 comPortInput.add(option, null);\r\n         });\r\n  });\r\n}\r\n```\r\n\r\n* **Open COM Port button function implementation**\r\n```javascript\r\nfunction serialPortOpen() {\r\n  var comPortInput = document.getElementById('comPort');\r\n  var comSelected = comPortInput.options[comPortInput.selectedIndex].text;\r\n  console.log(comSelected);\r\n  var SerialPort = serialport.SerialPort;\r\n  var serialPort = new SerialPort(comSelected, {\r\n         baudrate: 115200\r\n  }, false);\r\n  serialPort.open(function (err) {\r\n         if (err) {\r\n                 var textArea = document.getElementById('textArea');\r\n                 var tmp = textArea.value + err + '\\n';\r\n                 textArea.value = tmp;\r\n                 return;\r\n         }\r\n         serialPort.write('OMG IT WORKS\\r');\r\n  });\r\n}\r\n```\r\n\r\n### Firmware update control function implementation.\r\n\r\n* The protocol can get reference from F330 UART bootloader firmware. <br>\r\nFor quick demonstration purpose, we remove CRC function from firmware. The firmware main loop like below.\r\n\r\n```c\r\n while(SRC_Disp_TGT_Info() != SRC_RSP_OK);\r\n  SRC_Response = SRC_Get_Info();\r\n  SRC_Validate_Response(SRC_Response, SRC_CMD_GET_INFO);\r\n  if (Last_Error != 0)\r\n     goto error;\r\n  Flash_Key0 = rx_buf[5];\r\n  Flash_Key1 = rx_buf[6];\r\n  while(1){\r\n      SRC_Response = SRC_Get_Page_Info();\r\n      SRC_Page_CRC = rx_buf[4] | (rx_buf[5] << 8);\r\n      page_addr = rx_buf[1] | (rx_buf[2] << 8);\r\n      SRC_Validate_Response(SRC_Response, SRC_CMD_GET_PAGE_INFO);\r\n      if (Last_Error != 0)\r\n          break;\r\n      // Exit this loop if no more pages are available from source\r\n      if (SRC_Response == SRC_RSP_DATA_END)\r\n         break;\r\n      SRC_Response = SRC_Get_Page(Page_Buf);\r\n      SRC_Validate_Response(SRC_Response, SRC_CMD_GET_PAGE);\r\n      if (Last_Error != 0)\r\n         break;\r\n      TGT_Erase_Page(page_addr);\r\n      TGT_Write_Flash(Page_Buf, page_addr);\r\n}\r\n```\r\n\r\n* Test result.\r\n\r\na. Prepare C8051F330-TB board.<br>\r\nb. Download UART bootloader firmware in it.<br>\r\nc. Connect UART interface to PC, it appears COM4.<br>\r\nd. Press Ctrl+b to run the HTML5 updater.<br>\r\ne. Select blink sample application hex file by clicking Select Hex Files button.<br>\r\nf. Select COM4 from dropdown list, and click on Open COM Port button.<br>\r\ng. The blinky application will download to target board automatically. And reset MCU at end of updating.<br>\r\nh. We can see a green LED(D2) on board is blinking.<br>\r\ni. We are done!<br>\r\n\r\n![image039.png](https://raw.github.com/MarkDing/HTML5_UART_BL/master/images/image039.png)<br>\r\n\r\n### Source code\r\n The source code can be found from https://github.com/MarkDing/HTML5_UART_BL\r\n\r\n## LICENSE\r\nThe MIT License (MIT)\r\n\r\nCopyright (c) 2013 Mark Ding(mark.ding@hotmail.com)\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy of\r\nthis software and associated documentation files (the \"Software\"), to deal in\r\nthe Software without restriction, including without limitation the rights to\r\nuse, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\r\nthe Software, and to permit persons to whom the Software is furnished to do so,\r\nsubject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in all\r\ncopies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS\r\nFOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR\r\nCOPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER\r\nIN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN\r\nCONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}